<!DOCTYPE html>
<html>
<head>
    <title>Chart Debug</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #020b12; color: #e8f4f0; }
        .chart-container { background: #061520; border: 1px solid #00dc82; border-radius: 8px; height: 500px; margin: 20px 0; display: flex; flex-direction: column; position: relative; }
        .chart-main { flex: 1; position: relative; }
        .chart-volume { height: 100px; border-top: 1px solid #00dc82; position: relative; }
        button { background: #00dc82; color: #020b12; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        .debug { background: #061520; border: 1px solid #f5a623; border-radius: 8px; padding: 15px; margin: 10px 0; }
        canvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <h1>Chart Debug Test</h1>
    
    <div class="debug">
        <h3>Debug Info:</h3>
        <div id="debugInfo">Initializing...</div>
    </div>
    
    <button onclick="testChart()">Test Chart</button>
    <button onclick="addRandomCandle()">Add Random Candle</button>
    <button onclick="clearChart()">Clear Chart</button>
    
    <div class="chart-container">
        <div class="chart-main">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="chart-volume">
            <canvas id="volumeChart"></canvas>
        </div>
    </div>
    
    <script>
        let ohlcData = [];
        const debugInfo = document.getElementById('debugInfo');
        
        function updateDebug(message) {
            debugInfo.innerHTML += '<br>' + message;
            console.log(message);
        }
        
        function drawOHLCChart() {
            const canvas = document.getElementById('priceChart');
            if (!canvas) {
                updateDebug('‚ùå Price chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, width, height);
            
            if (ohlcData.length === 0) {
                ctx.fillStyle = '#888';
                ctx.font = '14px monospace';
                ctx.textAlign = 'center';
                ctx.fillText('No data - Click "Test Chart"', width / 2, height / 2);
                updateDebug('‚ö†Ô∏è No data to draw');
                return;
            }
            
            updateDebug(`‚úÖ Drawing ${ohlcData.length} candles`);
            
            const padding = 40;
            const chartWidth = width - (padding * 2);
            const chartHeight = height - (padding * 2);
            
            const allHighs = ohlcData.map(d => d.high);
            const allLows = ohlcData.map(d => d.low);
            const maxPrice = Math.max(...allHighs);
            const minPrice = Math.min(...allLows);
            const priceRange = maxPrice - minPrice || 1;
            
            // Draw grid
            ctx.strokeStyle = 'rgba(0, 220, 130, 0.1)';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(padding + chartWidth, y);
                ctx.stroke();
                
                const price = maxPrice - (maxPrice - minPrice) * (i / 5);
                ctx.fillStyle = '#888';
                ctx.font = '9px monospace';
                ctx.textAlign = 'right';
                ctx.fillText(`$${price.toFixed(2)}`, padding - 5, y + 3);
            }
            
            // Draw candles
            const candleWidth = Math.max(2, chartWidth / ohlcData.length - 2);
            
            ohlcData.forEach((candle, i) => {
                const x = padding + (chartWidth / (ohlcData.length - 1)) * i;
                
                const yOpen = padding + ((maxPrice - candle.open) / priceRange) * chartHeight;
                const yHigh = padding + ((maxPrice - candle.high) / priceRange) * chartHeight;
                const yLow = padding + ((maxPrice - candle.low) / priceRange) * chartHeight;
                const yClose = padding + ((maxPrice - candle.close) / priceRange) * chartHeight;
                
                const isGreen = candle.close >= candle.open;
                const color = isGreen ? '#00dc82' : '#ff4a6e';
                
                // High-low line
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(x, yHigh);
                ctx.lineTo(x, yLow);
                ctx.stroke();
                
                // Open-close box
                const boxHeight = Math.abs(yClose - yOpen) || 1;
                const boxY = Math.min(yOpen, yClose);
                
                if (isGreen) {
                    ctx.strokeRect(x - candleWidth/2, boxY, candleWidth, boxHeight);
                } else {
                    ctx.fillStyle = color;
                    ctx.fillRect(x - candleWidth/2, boxY, candleWidth, boxHeight);
                }
                
                // Last candle price
                if (i === ohlcData.length - 1) {
                    ctx.fillStyle = '#00dc82';
                    ctx.beginPath();
                    ctx.arc(x, yClose, 3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#00dc82';
                    ctx.font = 'bold 10px monospace';
                    ctx.textAlign = 'left';
                    ctx.fillText(`$${candle.close.toFixed(2)}`, x + 5, yClose + 3);
                }
            });
            
            updateDebug('‚úÖ Chart drawn successfully');
        }
        
        function drawVolumeChart() {
            const canvas = document.getElementById('volumeChart');
            if (!canvas) {
                updateDebug('‚ùå Volume chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;
            
            ctx.clearRect(0, 0, width, height);
            
            if (ohlcData.length === 0) return;
            
            const padding = 10;
            const chartWidth = width - (padding * 2);
            const chartHeight = height - (padding * 2);
            
            const volumes = ohlcData.map(d => d.volume || 0);
            const maxVolume = Math.max(...volumes);
            
            if (maxVolume === 0) return;
            
            const barWidth = Math.max(2, chartWidth / ohlcData.length - 2);
            
            ohlcData.forEach((candle, i) => {
                const x = padding + (chartWidth / (ohlcData.length - 1)) * i;
                const volume = candle.volume || 0;
                const barHeight = (volume / maxVolume) * chartHeight;
                const y = height - padding - barHeight;
                
                const isGreen = candle.close >= candle.open;
                ctx.fillStyle = isGreen ? 'rgba(0, 220, 130, 0.6)' : 'rgba(255, 74, 110, 0.6)';
                
                ctx.fillRect(x - barWidth/2, y, barWidth, barHeight);
            });
            
            ctx.fillStyle = '#888';
            ctx.font = '9px monospace';
            ctx.textAlign = 'left';
            ctx.fillText('VOL', padding, padding - 2);
        }
        
        function testChart() {
            updateDebug('üîÑ Testing chart with sample data...');
            
            // Generate sample data
            ohlcData = [];
            let basePrice = 150;
            
            for (let i = 0; i < 20; i++) {
                const volatility = 0.02;
                const change = (Math.random() - 0.5) * 2 * volatility;
                
                const open = basePrice;
                const close = open * (1 + change);
                const high = Math.max(open, close) * (1 + Math.random() * volatility * 0.5);
                const low = Math.min(open, close) * (1 - Math.random() * volatility * 0.5);
                
                ohlcData.push({
                    timestamp: Date.now() - (20 - i) * 60000,
                    open: open,
                    high: high,
                    low: low,
                    close: close,
                    volume: Math.floor(Math.random() * 10000000) + 1000000
                });
                
                basePrice = close;
            }
            
            drawOHLCChart();
            drawVolumeChart();
            updateDebug('‚úÖ Test completed');
        }
        
        function addRandomCandle() {
            if (ohlcData.length === 0) {
                testChart();
                return;
            }
            
            const lastCandle = ohlcData[ohlcData.length - 1];
            const volatility = 0.02;
            const change = (Math.random() - 0.5) * 2 * volatility;
            
            const open = lastCandle.close;
            const close = open * (1 + change);
            const high = Math.max(open, close) * (1 + Math.random() * volatility * 0.5);
            const low = Math.min(open, close) * (1 - Math.random() * volatility * 0.5);
            
            ohlcData.push({
                timestamp: Date.now(),
                open: open,
                high: high,
                low: low,
                close: close,
                volume: Math.floor(Math.random() * 10000000) + 1000000
            });
            
            if (ohlcData.length > 50) {
                ohlcData.shift();
            }
            
            drawOHLCChart();
            drawVolumeChart();
            updateDebug(`‚ûï Added candle at $${close.toFixed(2)}`);
        }
        
        function clearChart() {
            ohlcData = [];
            drawOHLCChart();
            drawVolumeChart();
            updateDebug('üóëÔ∏è Chart cleared');
        }
        
        // Initialize
        updateDebug('üöÄ Chart debug page loaded');
        drawOHLCChart();
        drawVolumeChart();
    </script>
</body>
</html>
